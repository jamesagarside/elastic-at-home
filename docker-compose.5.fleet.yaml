services:
  fleet-server:
    hostname: fleet-server
    depends_on:
      kibana:
        condition: service_healthy
    image: docker.elastic.co/elastic-agent/elastic-agent:${STACK_VERSION}
    volumes:
      - certs:/certs
      - fleetserverdata:/usr/share/elastic-agent
    ports:
      - ${FLEET_PORT}:8220
    networks:
      - elastic
    user: root
    extra_hosts:
      - "${ES_DOMAIN_NAME}:host-gateway"
      - "${FLEET_DOMAIN_NAME}:host-gateway"
      - "${KIBANA_DOMAIN_NAME}:host-gateway"
    environment:
      - ELASTICSEARCH_HOST=https://es01:9200
      - ELASTICSEARCH_USERNAME=elastic
      - ELASTICSEARCH_PASSWORD=${ELASTIC_PASSWORD}
      - ELASTICSEARCH_CA=/certs/ca/ca.crt
      - KIBANA_HOST=https://kibana:5601
      - KIBANA_CA=/certs/ca/ca.crt
      # Use internal URL for bootstrap - external agents use Traefik URL
      - FLEET_URL=https://fleet-server:8220
      - FLEET_SERVER_ENABLE=true
      - FLEET_SERVER_PORT=8220
      - FLEET_SERVER_CERT=/certs/fleet-server/fleet-server.crt
      - FLEET_SERVER_CERT_KEY=/certs/fleet-server/fleet-server.key
      - FLEET_SERVER_POLICY_ID=fleet-server-policy
      - CERTIFICATE_AUTHORITIES=/certs/ca/ca.crt
      # SSL for agent monitoring output
      - FLEET_SERVER_ELASTICSEARCH_CA=/certs/ca/ca.crt
      - SSL_CERTIFICATE_AUTHORITIES=/certs/ca/ca.crt
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.fleet.rule=Host(`${FLEET_DOMAIN_NAME}`)"
      - "traefik.http.routers.fleet.entrypoints=websecure"
      - "traefik.http.routers.fleet.tls=true"
      - "traefik.http.routers.fleet.tls.certresolver=${CERT_RESOLVER:-}"
      - "traefik.http.services.fleet.loadbalancer.server.port=8220"
      - "traefik.http.services.fleet.loadbalancer.server.scheme=https"
      # Reference serversTransport from file provider for TLS verification
      - "traefik.http.services.fleet.loadbalancer.serversTransport=fleet-transport@file"
    mem_limit: ${FLEET_MEM_LIMIT}
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -s --cacert /certs/ca/ca.crt https://localhost:8220/api/status | grep -q 'HEALTHY'",
        ]
      interval: 10s
      timeout: 10s
      retries: 120
volumes:
  fleetserverdata:
    driver: local
